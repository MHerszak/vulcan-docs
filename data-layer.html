<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <!-- Basic -->
    <title>Data Layer | Nova Docs</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="https://www.meteor.com/favicon.png" sizes="16x16 32x32 64x64">

    <!-- Social -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://nova-docs.telescopeapp.org">
    <meta property="og:title" content="Data Layer | Nova Docs">
    <meta property="og:description" content="">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_image_large">
    <meta name="twitter:site" content="@telescopeapp">
    <meta name="twitter:title" content="Data Layer | Nova Docs">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="">

    <!-- Misc -->
    <meta name="google-site-verification" content="" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,300italic,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/style/style.css">
  </head>
  <body class="">
    

<div class="nav dark">
  <div class="nav-group">
    <div class="nav-item show-mobile">
      <span class="js-sidebar-toggle ">
        <span class="icon-menu"></span>
      </span>
    </div>
    <div class="nav-item">
      <a class="logo-wrapper" href="http://nova-docs.telescopeapp.org/" title="Nova Documentation Nova Documentation"  >
        Nova Documentation
      </a>
    </div>
  </div>

  <div class="nav-group right">
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="https://github.com/telescopejs/telescope"  >
          <span>GitHub</span>
        </a>
      </div>
    
      
      <div class="nav-item show-desktop false ">
        <a class="link" href="http://slack.telescopeapp.org"  >
          <span>Slack</span>
        </a>
      </div>
    
  </div>
</div>

<div class="sidebar">
  <div class="panel">
    <div class="panel-item">
      <a class="" href="http://nova-docs.telescopeapp.org/" title="Nova Documentation"  >
        <span>Nova Documentation Nova Documentation</span>
      </a>
    </div>
    
      <div class="panel-item "">
        <a class="" href="https://github.com/telescopejs/telescope"  >
          <span>GitHub</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://slack.telescopeapp.org"  >
          <span>Slack</span>
        </a>
      </div>
    
  </div>

  <div class="sidebar-content">
    <div class="topcap">
      <span class="title-sidebar">Nova Docs</span>
      
    </div>

    

    <ul class="toc">
      
        <li>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="index.html" class="sidebar-link ">
                  <span>Introduction</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Overview</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="features.html" class="sidebar-link ">
                  <span>Features</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="architecture.html" class="sidebar-link ">
                  <span>Architecture</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">Tutorials</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="tutorial-customizing.html" class="sidebar-link ">
                  <span>Customizing & Extending Nova</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="tutorial-framework.html" class="sidebar-link ">
                  <span>Understanding the Nova Framework</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">API</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="theming.html" class="sidebar-link ">
                  <span>Components & Theming</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="custom-fields.html" class="sidebar-link ">
                  <span>Custom Fields</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="schema.html" class="sidebar-link ">
                  <span>Schema</span>
                </a>
              </li>
            
              
              <li class="item-toc  current">
                <a href="" class="sidebar-link  current">
                  <span>Data Layer</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="forms.html" class="sidebar-link ">
                  <span>Forms</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="callbacks.html" class="sidebar-link ">
                  <span>Callbacks</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="email.html" class="sidebar-link ">
                  <span>Email</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="groups-permissions.html" class="sidebar-link ">
                  <span>Groups & Permissions</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="routing.html" class="sidebar-link ">
                  <span>Routing</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="internationalization.html" class="sidebar-link ">
                  <span>Internationalization</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="settings.html" class="sidebar-link ">
                  <span>Settings</span>
                </a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </div>
</div>

<div class="content">
  <div class="content-wrapper">
    <div class="header-content">
      <h1 class="title-page">Data Layer</h1>
      

      <div class="page-actions">
        <div class="actions-group">
          <a class="btn tertiary small round lowercase" href="https://github.com/telescopejs/nova-docs/tree/master/source/data-layer.md" target="_blank"><span class="icon-github"></span> <span>Edit on GitHub</span></a>
          
        </div>
      </div>
    </div>

    <div class="document-formatting">
      <p>Nova uses the <a href="http://apollostack.com" target="_blank" rel="external">Apollo</a> data layer to manage its <a href="http://graphql.org/" target="_blank" rel="external">GraphQL API</a>. </p>
<h2 id="Data-Flow"><a href="#Data-Flow" class="headerlink" title="Data Flow"></a>Data Flow</h2><p>When you connect to a GraphQL-powered site, the client makes an API request to load the data it needs. </p>
<p>Unlike traditional REST APIs, the client doesn’t just hit an API endpoint but actually sends a list of <em>what data it needs</em> to the server. The specific document properties needed by the client are defined in a <strong>fragment</strong>. </p>
<p>Upon receiving that query, the server validates the fragment against the main GraphQL <strong>schema</strong>.</p>
<p>If that validation passes, the server then looks for a <strong>query resolver</strong> that will specify how to actually retrieve the data (presumably through some kind of database <code>find()</code> operation).</p>
<p>Data mutations (inserting, editing, or removing a document) function in a similar way.</p>
<p>The client sends a query that includes the name of the mutation, the mutation arguments, as well as specifies what data the client expects back once the mutation is complete. </p>
<p>The server then looks for a <strong>mutation resolver</strong> and executes it.</p>
<h2 id="Helper-Functions"><a href="#Helper-Functions" class="headerlink" title="Helper Functions"></a>Helper Functions</h2><p>Nova features a number of helpers to make settings up that data layer fast, most of which are initialized through the <code>createCollection</code> function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Movies = createCollection(&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">collectionName</span>: <span class="string">'movies'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">typeName</span>: <span class="string">'Movie'</span>,</span><br><span class="line"></span><br><span class="line">  schema,</span><br><span class="line">  </span><br><span class="line">  resolvers,</span><br><span class="line"></span><br><span class="line">  mutations,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The function takes the following arguments:</p>
<ul>
<li><code>collectionName</code>: the name of the collection in your MongoDB database.</li>
<li><code>typeName</code>: the name of the GraphQL type that will be generated for the collection.</li>
<li><code>schema</code>, <code>resolvers</code>, <code>mutations</code>: see below.</li>
</ul>
<h2 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h2><p>The first piece of any GraphQL API is the <strong>schema</strong>, which defines what data is made available to the client. </p>
<p>In Nova, this GraphQL schema can be generated automatically from your collection’s JSON schema, so you don’t have to type things twice. Just pass a <a href="https://github.com/aldeed/meteor-simple-schema" target="_blank" rel="external">SimpleSchema</a>-compatible JSON schema as <code>createCollection</code>‘s <code>schema</code> property.</p>
<p>You can learn more on defining your schema in the <a href="schema.html">Schema</a> section.</p>
<h3 id="Custom-Schemas"><a href="#Custom-Schemas" class="headerlink" title="Custom Schemas"></a>Custom Schemas</h3><p>If you need to manually add a schema, you can also do so using the <code>GraphQLSchema.addSchema</code> function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> customSchema = <span class="string">`</span><br><span class="line">  input Custom &#123;</span><br><span class="line">    _id: String</span><br><span class="line">    userId: String</span><br><span class="line">    title: String</span><br><span class="line">  &#125;</span><br><span class="line">`</span>;</span><br><span class="line">GraphQLSchema.addSchema(customSchema);</span><br></pre></td></tr></table></figure>
<h2 id="Resolvers"><a href="#Resolvers" class="headerlink" title="Resolvers"></a>Resolvers</h2><p>You can pass a <code>resolver</code> object to <code>createCollection</code>. It should include three <code>list</code>, <code>single</code>, and <code>total</code> resolvers.</p>
<p>Each resolver should have the following properties:</p>
<ul>
<li><code>name</code>: the resolver’s name.</li>
<li><code>resolver</code>: the resolver function.</li>
</ul>
<h3 id="List-Resolver"><a href="#List-Resolver" class="headerlink" title="List Resolver"></a>List Resolver</h3><p>The <code>list</code> resolver is used to display lists of documents. It takes the following arguments:</p>
<ul>
<li><code>terms</code>: a JSON object containing a list of terms used to filter and sort the list.</li>
<li><code>offset</code>: how many documents to offset the list by (used for paginating requests).</li>
<li><code>limit</code>: how many documents to return.</li>
</ul>
<p>It should return an array of documents.</p>
<h3 id="Single-Resolver"><a href="#Single-Resolver" class="headerlink" title="Single Resolver"></a>Single Resolver</h3><p>The <code>single</code> resolver takes a <code>documentId</code> argument, and should return a single document.</p>
<h3 id="List-Total-Resolver"><a href="#List-Total-Resolver" class="headerlink" title="List Total Resolver"></a>List Total Resolver</h3><p>The <code>total</code> resolver takes a <code>terms</code> argument and should return the total count of results matching these terms in the database. </p>
<h3 id="Custom-Resolvers"><a href="#Custom-Resolvers" class="headerlink" title="Custom Resolvers"></a>Custom Resolvers</h3><p>Just like for the schema, you can also define resolvers manually using <code>GraphQLSchema.addResolvers</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> movieResolver = &#123;</span><br><span class="line">  <span class="attr">Movie</span>: &#123;</span><br><span class="line">    user(movie, args, context) &#123;</span><br><span class="line">      <span class="keyword">return</span> context.Users.findOne(&#123; <span class="attr">_id</span>: movie.userId &#125;, &#123; <span class="attr">fields</span>: context.getViewableFields(context.currentUser, context.Users) &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">GraphQLSchema.addResolvers(movieResolver);</span><br></pre></td></tr></table></figure>
<p>Resolvers can be defined on any new or existing type (e.g. <code>Movie</code>).</p>
<h2 id="Mutations"><a href="#Mutations" class="headerlink" title="Mutations"></a>Mutations</h2><p>Finally, <code>createCollection</code> also accepts a <code>mutations</code> object. This object should include three mutations, <code>new</code>, <code>edit</code>, and <code>remove</code>, each of which has the following properties:</p>
<ul>
<li><code>name</code>: the name of the mutation.</li>
<li><code>check</code>: a function that takes the current user and (optionally) the document being operated on, and return <code>true</code> or <code>false</code> based on whether the user can perform the operation.</li>
<li><code>mutation</code>: the mutation function.</li>
</ul>
<h3 id="New-Mutation"><a href="#New-Mutation" class="headerlink" title="New Mutation"></a>New Mutation</h3><p>Takes a single <code>document</code> argument.</p>
<h3 id="Edit-Mutation"><a href="#Edit-Mutation" class="headerlink" title="Edit Mutation"></a>Edit Mutation</h3><p>Takes three arguments:</p>
<ul>
<li><code>documentId</code>: the document to modify.</li>
<li><code>set</code>: the fields to modify (as a list of field name/value pairs, e.g.<code>{title: &#39;My New Title&#39;, body: &#39;My new body&#39;}</code>).</li>
<li><code>unset</code>: the fields to remove (as a list of field names/booleans, e.g. <code>{title: true, body: true}</code>).</li>
</ul>
<h3 id="Remove-Mutation"><a href="#Remove-Mutation" class="headerlink" title="Remove Mutation"></a>Remove Mutation</h3><p>Takes a single <code>documentId</code> argument.</p>
<h3 id="Custom-Mutations"><a href="#Custom-Mutations" class="headerlink" title="Custom Mutations"></a>Custom Mutations</h3><p>You can also add your own mutations using <code>GraphQLSchema.addMutation</code> and <code>GraphQLSchema.addResolvers</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">GraphQLSchema.addMutation(<span class="string">'postsVote(documentId: String, voteType: String) : Post'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> voteResolver = &#123;</span><br><span class="line">  <span class="attr">Mutation</span>: &#123;</span><br><span class="line">    postsVote(root, &#123;documentId, voteType&#125;, context) &#123;</span><br><span class="line">      <span class="comment">// do mutation</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">GraphQLSchema.addResolvers(voteResolver);</span><br></pre></td></tr></table></figure>
<h3 id="Boilerplate-Operations"><a href="#Boilerplate-Operations" class="headerlink" title="Boilerplate Operations"></a>Boilerplate Operations</h3><p>Note that even when using the <code>new</code>, <code>edit</code>, and <code>remove</code> mutations, defining the actual operation is up to you.</p>
<p>But if you want to save time, you can import Telescope’s own boilerplate mutations from <code>nova:lib</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; newMutation, editMutation, removeMutation &#125; <span class="keyword">from</span> <span class="string">'meteor/nova:lib'</span>;</span><br></pre></td></tr></table></figure>
<p>They take the following arguments:</p>
<ul>
<li><code>collection</code>: the collectin affected.</li>
<li><code>document</code> (new) or <code>documentId</code> (edit, remove): the document or document ID.</li>
<li><code>set</code>, <code>unset</code> (edit only): the <code>set</code> and <code>unset</code> objects. </li>
<li><code>currentUser</code>: the user performing the operation.</li>
<li><code>validate</code>: whether to validate the operation based on the current user.</li>
<li><code>context</code>: the resolver context.</li>
</ul>
<p>If <code>validate</code> is set to <code>true</code>, these boilerplate operations will: </p>
<ul>
<li>Check that the current user has permission to insert/edit each field.</li>
<li>Validate the document against collection schema.</li>
<li>Add <code>userId</code> to document (insert only).</li>
<li>Run any validation callbacks (e.g. <code>movies.new.validate</code>).</li>
</ul>
<p>They will then run the mutation’s document (or the <code>set</code> modifier) through the collection’s sync callbacks (e.g. <code>movies.new.sync</code>), perform the operation, and finally run the async callbacks (e.g. <code>movies.new.async</code>).</p>
<p>Callback hooks run with the following arguments:</p>
<ul>
<li><code>new</code>: <code>newDocument</code>, <code>currentUser</code>.</li>
<li><code>edit</code>: <code>modifier</code>, <code>oldDocument</code>, <code>currentUser</code>.</li>
<li><code>remove</code>: <code>document</code>, <code>currentUser</code>.</li>
</ul>
<p>You can learn more about callbacks in the <a href="callbacks.html">Callbacks</a> section. </p>
<h2 id="Higher-Order-Components"><a href="#Higher-Order-Components" class="headerlink" title="Higher-Order Components"></a>Higher-Order Components</h2><p>To make working with Apollo easier, Nova provides you with a set of higher-order components (HoC). </p>
<p>An HoC is simply a function you can call on a React component to give it additional props.</p>
<h3 id="withList"><a href="#withList" class="headerlink" title="withList"></a>withList</h3><p>The <code>withList</code> HoC is used to display lists of documents. It takes the following options:</p>
<ul>
<li><code>queryName</code>: an arbitrary name for the query.</li>
<li><code>collection</code>: the collection on which to look for the <code>list</code> resolver.</li>
<li><code>fragment</code>: the fragment to use (see below).</li>
</ul>
<p>For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> listOptions = &#123;</span><br><span class="line">  <span class="attr">collection</span>: Movies,</span><br><span class="line">  <span class="attr">queryName</span>: <span class="string">'moviesListQuery'</span>,</span><br><span class="line">  <span class="attr">fragment</span>: MoviesItem.fragment,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withList(listOptions)(MoviesList);</span><br></pre></td></tr></table></figure>
<p>The resulting wrapped component also takes in the following options:</p>
<ul>
<li><code>terms</code>: an object containing a list of quering, sorting, and filtering terms.</li>
</ul>
<p>Note that <code>terms</code> needs to be passed not as an option, but as a prop from the <em>parent</em> component.</p>
<p>The HoC then passes on the following props:</p>
<ul>
<li><code>loading</code>: <code>true</code> while the data is loading.</li>
<li><code>results</code>: the loaded array of documents.</li>
<li><code>totalCount</code>: the total count of results.</li>
<li><code>count</code>: the number of current results (i.e. <code>results.length</code>).</li>
<li><code>refetch</code>: a function that can be called to trigger a query refetch.</li>
<li><code>loadMore</code>: a function that can be called to load more data. </li>
</ul>
<h3 id="withDocument"><a href="#withDocument" class="headerlink" title="withDocument"></a>withDocument</h3><p>The <code>withDocument</code> HoC displays a single document. It takes the same options as <code>withList</code>, but takes a <code>documentId</code> <strong>prop</strong>. </p>
<p>Like <code>terms</code> for <code>withList</code>, <code>documentId</code> needs to be passed not as an option, but as a prop from the <em>parent</em> component.</p>
<p>This HoC then passes on the following child prop:</p>
<ul>
<li><code>loading</code>: <code>true</code> while the data is loading.</li>
<li><code>document</code>: the loaded document.</li>
</ul>
<h3 id="withNew"><a href="#withNew" class="headerlink" title="withNew"></a>withNew</h3><p>This HoC takes the following four options:</p>
<ul>
<li><code>collection</code>: the collection to operate on.</li>
<li><code>queryName</code>: the name of the query to update on the client.</li>
<li><code>fragment</code>: specifies the data to ask for as a return value.</li>
</ul>
<p>And passes on a <code>newMutation</code> function to the wrapped component, which takes a single <code>document</code> argument.</p>
<h3 id="withEdit"><a href="#withEdit" class="headerlink" title="withEdit"></a>withEdit</h3><p>Same options as <code>withNew</code>. The returned <code>editMutation</code> mutation takes three arguments: <code>documentId</code>, <code>set</code>, and <code>unset</code>. </p>
<h3 id="withRemove"><a href="#withRemove" class="headerlink" title="withRemove"></a>withRemove</h3><p>Same options as <code>withNew</code>. The returned <code>removeMutation</code> mutation takes a single <code>documentId</code> argument. </p>
<p>Note that when using the <a href="forms.html">Forms</a> module, all three mutation HoCs are automatically added for you. </p>
<h2 id="Fragments"><a href="#Fragments" class="headerlink" title="Fragments"></a>Fragments</h2><p>A fragment is a piece of schema, usually used to define what data you want to query for. </p>
<p>A good practice is defining the fragment wherever the data will actually be used. Note that this doesn’t have to be the component that directly receives this data. </p>
<p>For example, you could define a fragment in one component:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoviesItem</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MoviesItem.fragment = gql<span class="string">`</span><br><span class="line">  fragment moviesItemFragment on Movie &#123;</span><br><span class="line">    _id</span><br><span class="line">    name</span><br><span class="line">    year</span><br><span class="line">    user &#123;</span><br><span class="line">      __displayName</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> MoviesItem;</span><br></pre></td></tr></table></figure>
<p>And reuse it in another:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> listOptions = &#123;</span><br><span class="line">  <span class="attr">collection</span>: Movies,</span><br><span class="line">  <span class="attr">queryName</span>: <span class="string">'moviesListQuery'</span>,</span><br><span class="line">  <span class="attr">fragment</span>: MoviesItem.fragment,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withList(listOptions)(MoviesList);</span><br></pre></td></tr></table></figure>
<h2 id="Terms-amp-Parameters"><a href="#Terms-amp-Parameters" class="headerlink" title="Terms &amp; Parameters"></a>Terms &amp; Parameters</h2><p>When you request data, you often want to do it according to specific criteria. For example, you might want to load all posts from a certain category, and order them by score. </p>
<p>Nova accomplishes this through MongoDB operators such as <code>find</code>, <code>sort</code>, etc. but because it would be dangerous to let the client specify its own operators, the client instead defines a <code>terms</code> object which gets converted into MongoDB-compatible objects using the <code>collection.getParameters</code> function. </p>
<p>For example, given the following <code>terms</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">view</span>: <span class="string">'top'</span>,</span><br><span class="line">  <span class="attr">cat</span>: <span class="string">'foo'</span>,</span><br><span class="line">  <span class="attr">after</span>: <span class="string">'2016-12-01'</span>,</span><br><span class="line">  <span class="attr">before</span>: <span class="string">'2016-12-31'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Calling <code>Posts.getParameters(terms)</code> would give you the following object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">selector</span>: &#123; </span><br><span class="line">    <span class="attr">status</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">isFuture</span>: &#123; <span class="string">'$ne'</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">postedAt</span>: &#123; </span><br><span class="line">      <span class="string">'$gte'</span>: Thu Dec <span class="number">01</span> <span class="number">2016</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0900</span> (JST),</span><br><span class="line">      <span class="string">'$lt'</span>: Sat Dec <span class="number">31</span> <span class="number">2016</span> <span class="number">23</span>:<span class="number">59</span>:<span class="number">59</span> GMT+<span class="number">0900</span> (JST)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">categories</span>: &#123; <span class="string">'$in'</span>: [<span class="string">'RmpzcMurbFysAAvhf'</span>] &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">options</span>: &#123; </span><br><span class="line">    <span class="attr">sort</span>: &#123; </span><br><span class="line">      <span class="attr">sticky</span>: <span class="number">-1</span>, <span class="attr">score</span>: <span class="number">-1</span>, <span class="attr">_id</span>: <span class="number">-1</span> </span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">limit</span>: <span class="number">10</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, the resulting object is a mix of default properties (<code>status</code>, <code>isFuture</code>) and properties calculated from the <code>terms</code> object (<code>postedAt.$gte</code>, <code>postedAt.$lt</code>, <code>categories</code>, etc.). </p>
<p>Behind the scenes the <code>Posts.getParameters</code> function iterates through all the functions defined on the <code>posts.parameters</code> callback hook until it produces the final <code>{ selector, options}</code> object. </p>
<p>This means you can handle additional <code>terms</code> parameters simply by adding your own callback. For example, this is how you would use a <code>cat</code> parameter accepting a category slug to fetch the corresponding category when querying the <code>Posts</code> collection:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; addCallback &#125; <span class="keyword">from</span> <span class="string">'meteor/nova:core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addCategoryParameter</span> (<span class="params">parameters, terms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (terms.cat) &#123;</span><br><span class="line">    <span class="keyword">const</span> categoryId = Categories.findOne(&#123;<span class="attr">slug</span>: terms.cat&#125;)._id;</span><br><span class="line">    parameters.selector.category = &#123;<span class="attr">$in</span>: categoryId&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> parameters;</span><br><span class="line">&#125;</span><br><span class="line">addCallback(<span class="string">'posts.parameters'</span>, addCategoryParameter);</span><br></pre></td></tr></table></figure>
<p>Note that in the default <code>PostsHome</code> component, the <code>terms</code> object is automatically built from the current URL query parameters:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PostsHome = <span class="function">(<span class="params">props, context</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> terms = _.isEmpty(props.location &amp;&amp; props.location.query) ? &#123;<span class="attr">view</span>: <span class="string">'top'</span>&#125;: props.location.query;</span><br><span class="line">  <span class="keyword">return</span> &lt;Components.PostsList terms=&#123;terms&#125;/&gt;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Posts-Views"><a href="#Posts-Views" class="headerlink" title="Posts Views"></a>Posts Views</h3><p>One of the parameters accepted by the <code>Posts</code> collection is <code>view</code>, which functions as a shorthand for defining multiple parameters at the same time. For example, this is how the <code>pending</code> view is defined in order to only show pending posts, while ordering them by their <code>createdAt</code> property:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Posts.views.add(<span class="string">"pending"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">terms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">selector</span>: &#123;</span><br><span class="line">      <span class="attr">status</span>: Posts.config.STATUS_PENDING</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">options</span>: &#123;<span class="attr">sort</span>: &#123;<span class="attr">createdAt</span>: <span class="number">-1</span>&#125;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Since a view is a function that takes the <code>terms</code> object as argument, you can make it dynamic. For example, here’s how you would show all posts upvoted by a user:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Posts.views.add(<span class="string">"userUpvotedPosts"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">terms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">selector</span>: &#123;</span><br><span class="line">      <span class="attr">upvoters</span>: &#123;<span class="attr">$in</span>: [terms.userId]&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">options</span>: &#123;</span><br><span class="line">      <span class="attr">sort</span>: &#123;</span><br><span class="line">        <span class="attr">postedAt</span>: <span class="number">-1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Note that views currently only work with the <code>Posts</code> collection, but this might change in the future. </p>
<h3 id="On-The-Client"><a href="#On-The-Client" class="headerlink" title="On The Client"></a>On The Client</h3><p>Although the primary function of the <code>terms</code> object is to figure out the <code>selector</code> and <code>options</code> to use on the server to fetch data from the database, it’s also used on the client to make sure data is kept in a logical state as it gets updated. </p>
<p>For example, let’s imagine you’re viewing posts filtered by a specific category. If you were to edit one of these posts to remove its category, we need to make sure the post is removed from the list since it doesn’t match the inclusion criteria anymore. </p>
<p>Instead of refetching the whole list from the server, we can do this transparently using <a href="https://github.com/kofrasa/mingo" target="_blank" rel="external">Mingo</a> to resort the data on the client using the same <code>selector</code> and <code>options</code> objects. </p>

    </div>
  </div>

  <div class="pagination">
    <div class="content-wrapper">
      
      
        <a class="link primary prev"
          href="schema.html">
          <span class="icon-arrow-left-alt"></span>
          <span class="subtitle-pagination">Previous</span>
          Schema
        </a>
      
      
        <a class="link primary next"
          href="forms.html">
          <span class="subtitle-pagination">Next</span>
          Forms
          <span class="icon-arrow-right-alt"></span>
        </a>
      
    </div>
  </div>

  <div class="github">
    <a class="link tertiary " href="https://github.com/telescopejs/nova-docs/tree/master/source/data-layer.md" target="_blank">
      <span class="icon-github"></span>Edit on GitHub</a>
  </div>

  
</div>

    <script src="/script/smooth-scroll.min.js"></script>
    <script src="/script/main.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>


    <script>
      
    </script>
  </body>
</html>
